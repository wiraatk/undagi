<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Undangan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>body{font-family:'Montserrat',sans-serif}</style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <nav class="bg-white shadow-sm px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <h1 class="font-bold text-lg text-slate-800"><i class="fas fa-share-alt text-blue-600"></i> KELOLA & SEBAR</h1>
        <a href="dashboard.html" class="text-xs font-bold text-slate-500 hover:text-blue-600">KEMBALI KE EDIT</a>
    </nav>

    <div class="max-w-md mx-auto p-6 space-y-6">

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center">
            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Status Akun</p>
            <div id="statusLoading" class="animate-pulse h-6 w-24 bg-slate-200 rounded mx-auto"></div>
            
            <div id="statusFree" class="hidden">
                <span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold">FREE</span>
                <p class="text-xs text-slate-500 mt-2">Musik & Galeri Terkunci.</p>
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-left">
                    <p class="text-xs font-bold text-yellow-700">Mau Upgrade Premium?</p>
                    <p class="text-[10px] text-slate-600 mt-1">Hanya 50rb selamanya.</p>
                    <button onclick="upgradePremium()" class="mt-2 w-full bg-green-500 text-white py-2 rounded text-xs font-bold"><i class="fab fa-whatsapp"></i> Chat Admin</button>
                </div>
            </div>

            <div id="statusPremium" class="hidden">
                <span class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white px-4 py-1 rounded-full text-xs font-bold shadow">ðŸ‘‘ PREMIUM</span>
                <p class="text-xs text-green-600 mt-2 font-bold">Semua Fitur Aktif!</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-blue-600">
            <h2 class="font-bold text-lg mb-1">Buat Link Tamu</h2>
            <p class="text-xs text-slate-500 mb-4">Masukkan nama tamu agar muncul di cover undangan.</p>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-700">Nama Tamu (Kepada Yth)</label>
                    <input type="text" id="guestName" placeholder="Contoh: Bpk. Wayan & Keluarga" class="w-full mt-1 p-3 bg-slate-50 border border-slate-300 rounded-xl text-sm focus:border-blue-500 outline-none">
                </div>

                <button onclick="generateLink()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-lg">
                    BUAT LINK
                </button>

                <div id="resultBox" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200 animate-fade-in">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Link Khusus:</p>
                    <input type="text" id="finalLink" class="w-full bg-white border p-2 rounded text-xs text-blue-600 font-mono mb-3" readonly>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="copyLink()" class="bg-white border border-slate-300 text-slate-600 py-2 rounded-lg text-xs font-bold hover:bg-gray-50">
                            <i class="fas fa-copy"></i> Salin
                        </button>
                        <button onclick="sendWA()" class="bg-green-500 text-white py-2 rounded-lg text-xs font-bold hover:bg-green-600 shadow-md">
                            <i class="fab fa-whatsapp"></i> Kirim WA
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { auth, db, doc, getDoc, onAuthStateChanged } from './firebase-config.js';

        let currentUser = null;
        let baseViewUrl = "";
        let coupleName = "Kami";

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Setup URL dasar
                const currentUrl = window.location.href;
                baseViewUrl = currentUrl.replace('manage.html', 'view.html').split('?')[0] + `?uid=${user.uid}`;
                
                await checkStatus(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        async function checkStatus(uid) {
            const docSnap = await getDoc(doc(db, "invitations", uid));
            document.getElementById('statusLoading').classList.add('hidden');
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                // Simpan nama mempelai untuk pesan WA
                coupleName = `${data.groomNick || 'Pria'} & ${data.brideNick || 'Wanita'}`;

                if (data.plan === 'premium') {
                    document.getElementById('statusPremium').classList.remove('hidden');
                } else {
                    document.getElementById('statusFree').classList.remove('hidden');
                }
            }
        }

        window.generateLink = () => {
            const name = document.getElementById('guestName').value.trim();
            if (!name) return alert("Masukkan nama tamu dulu!");

            const encodedName = encodeURIComponent(name);
            const fullLink = `${baseViewUrl}&to=${encodedName}`;
            
            document.getElementById('finalLink').value = fullLink;
            document.getElementById('resultBox').classList.remove('hidden');
        };

        window.copyLink = () => {
            const link = document.getElementById('finalLink');
            link.select();
            navigator.clipboard.writeText(link.value);
            alert("Link tersalin!");
        };

        window.sendWA = () => {
            const name = document.getElementById('guestName').value;
            const link = document.getElementById('finalLink').value;
            
            // PESAN WA KHUSUS BALI
            const text = `Om Swastyastu,\n\nKepada Yth. ${name},\n\nTanpa mengurangi rasa hormat, perkenankan kami mengundang Bapak/Ibu/Saudara/i untuk hadir dalam acara Pawiwahan kami:\n\n*${coupleName}*\n\nBerikut link undangan digital kami:\n${link}\n\nMerupakan suatu kehormatan bagi kami apabila Bapak/Ibu/Saudara/i berkenan hadir dan memberikan doa restu.\n\nSuksma.\nOm Shanti Shanti Shanti Om.`;
            
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        };

        window.upgradePremium = () => {
            const text = `Halo Admin, saya mau upgrade akun ke Premium.\nEmail: ${currentUser.email}`;
            window.open(`https://wa.me/6282187454828?text=${encodeURIComponent(text)}`, '_blank');
        };
    </script>
</body>
</html>
