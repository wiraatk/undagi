<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pengantin - Undagi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body{font-family:'Montserrat',sans-serif}
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid #e5e7eb; }
        
        .gallery-slot {
            aspect-ratio: 1; border: 2px dashed #cbd5e1; border-radius: 0.75rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; position: relative; background-color: #f8fafc; transition: all 0.3s;
        }
        .gallery-slot:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .gallery-slot img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-slot .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;
        }
        .gallery-slot:hover .overlay { opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-28">

    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-30 shadow-md">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="index.html" class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-white hover:bg-blue-500 transition">U</a>
                <div>
                    <h1 class="font-bold text-sm">Dashboard</h1>
                    <p class="text-[10px] text-slate-400" id="userEmail">Memuat...</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="planBadge" class="bg-gray-700 text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wider mr-2">FREE</span>
                
                <a href="index.html" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white transition" title="Ke Halaman Utama">
                    <i class="fas fa-home"></i>
                </a>

                <button onclick="logout()" class="w-8 h-8 flex items-center justify-center rounded-full bg-red-900/50 hover:bg-red-600 text-red-200 hover:text-white transition" title="Keluar Akun">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto p-6 space-y-6">

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h2 class="font-bold text-blue-600 mb-4 flex items-center gap-2"><i class="fas fa-paint-brush"></i> Tampilan</h2>
            
            <div class="mb-4">
                <label class="text-xs font-bold text-slate-500">Tema Desain</label>
                <select id="theme" class="w-full mt-1 p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm focus:border-blue-500 outline-none">
                    <option value="gold">Gold Luxury</option>
                    <option value="silver">Silver Minimal</option>
                    <option value="sage">Sage Nature</option>
                    <option value="maroon">Red Maroon</option>
                </select>
            </div>

            <div>
                <label class="text-xs font-bold text-slate-500">Foto Cover Utama</label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="coverPhoto" placeholder="Link foto..." class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs">
                    <button onclick="handleFileUpload('coverPhoto', 'image')" class="bg-slate-200 px-4 rounded-xl hover:bg-slate-300"><i class="fas fa-camera"></i></button>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h2 class="font-bold text-blue-600 mb-4 flex items-center gap-2"><i class="fas fa-user-friends"></i> Mempelai</h2>
            
            <div class="mb-6 pb-6 border-b border-dashed border-slate-200">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Mempelai Pria</p>
                <div class="space-y-3">
                    <input type="text" id="groomName" placeholder="Nama Lengkap Pria" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="groomNick" placeholder="Nama Panggilan" class="p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                        <div class="flex gap-1">
                            <input type="text" id="groomPhoto" placeholder="Link Foto" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs">
                            <button onclick="handleFileUpload('groomPhoto', 'image')" class="bg-slate-200 px-3 rounded-xl"><i class="fas fa-upload"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="groomFather" placeholder="Nama Ayah" class="p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                        <input type="text" id="groomMother" placeholder="Nama Ibu" class="p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                    </div>
                </div>
            </div>

            <div>
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Mempelai Wanita</p>
                <div class="space-y-3">
                    <input type="text" id="brideName" placeholder="Nama Lengkap Wanita" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="brideNick" placeholder="Nama Panggilan" class="p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                        <div class="flex gap-1">
                            <input type="text" id="bridePhoto" placeholder="Link Foto" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs">
                            <button onclick="handleFileUpload('bridePhoto', 'image')" class="bg-slate-200 px-3 rounded-xl"><i class="fas fa-upload"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="brideFather" placeholder="Nama Ayah" class="p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                        <input type="text" id="brideMother" placeholder="Nama Ibu" class="p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h2 class="font-bold text-blue-600 mb-4 flex items-center gap-2"><i class="fas fa-calendar-alt"></i> Acara</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500">Tanggal</label>
                        <input type="date" id="eventDate" class="w-full mt-1 p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500">Jam (WITA)</label>
                        <input type="time" id="eventTime" class="w-full mt-1 p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500">Lokasi / Nama Gedung</label>
                    <textarea id="eventLocation" rows="2" class="w-full mt-1 p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm"></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500">Link Google Maps</label>
                    <input type="text" id="mapsUrl" placeholder="https://maps.google.com/..." class="w-full mt-1 p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h2 class="font-bold text-blue-600 mb-4 flex items-center gap-2"><i class="fas fa-wallet"></i> Amplop Digital</h2>
            <div class="space-y-3">
                <input type="text" id="bankName" placeholder="Nama Bank (BCA/BRI/Dana)" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="accountNumber" placeholder="No. Rekening" class="p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                    <input type="text" id="accountHolder" placeholder="Atas Nama" class="p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm">
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h2 class="font-bold text-blue-600 mb-4 flex items-center gap-2"><i class="fas fa-images"></i> Galeri & Musik</h2>
            
            <div class="mb-6">
                <label class="text-xs font-bold text-slate-500 mb-2 block flex justify-between">
                    Galeri Foto (Maks 8)
                    <span class="text-[10px] bg-green-100 text-green-700 px-2 rounded-full">Semua Paket</span>
                </label>
                
                <div class="grid grid-cols-4 gap-2" id="galleryContainer">
                    </div>
                <p class="text-[10px] text-gray-400 mt-2">*Klik kotak untuk upload/ganti foto.</p>
            </div>

            <hr class="border-dashed border-slate-200 my-6">

            <div>
                <label class="text-xs font-bold text-slate-500 flex justify-between">
                    Musik Latar (MP3)
                    <span class="text-[10px] text-blue-600 bg-blue-50 px-2 rounded-full">Upload Bebas</span>
                </label>
                <div class="flex gap-2 mt-1">
                    <input type="text" id="music" placeholder="Link musik / Upload MP3..." class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs text-gray-500" readonly>
                    <button onclick="handleFileUpload('music', 'audio')" class="bg-purple-100 text-purple-600 px-4 rounded-xl hover:bg-purple-200 transition flex items-center gap-2 font-bold text-xs whitespace-nowrap">
                        <i class="fas fa-music"></i> Upload
                    </button>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">*Musik akan otomatis diputar saat undangan dibuka.</p>
            </div>
        </div>

    </main>

    <div class="fixed bottom-0 w-full glass-nav p-4 z-40">
        <div class="max-w-3xl mx-auto flex gap-3">
            <button onclick="previewInvitation()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-200 transition flex items-center justify-center gap-2">
                <i class="fas fa-eye"></i> <span class="hidden sm:inline">Preview</span>
            </button>
            <button onclick="saveData()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-lg shadow-blue-500/30">
                <i class="fas fa-save"></i> Simpan
            </button>
            <a href="manage.html" class="flex-1 bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 transition flex items-center justify-center gap-2 shadow-lg shadow-green-500/30">
                <i class="fas fa-share-alt"></i> Bagikan
            </a>
        </div>
    </div>

    <script type="module">
        import { auth, db, doc, getDoc, setDoc, onAuthStateChanged, signOut } from './firebase-config.js';
        import { uploadFile } from './cloudinary.js';

        let currentUser = null;
        let currentData = {};
        let galleryData = ["", "", "", "", "", "", "", ""]; 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmail').innerText = user.email;
                loadData(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        async function loadData(uid) {
            try {
                const docSnap = await getDoc(doc(db, "invitations", uid));
                if (docSnap.exists()) {
                    currentData = docSnap.data();
                    
                    // Helper Smart Load (Support data lama)
                    const getVal = (field, oldField) => {
                        return currentData[field] || (currentData[oldField.split('.')[0]] ? currentData[oldField.split('.')[0]][oldField.split('.')[1]] : '') || '';
                    };

                    fillForm(currentData, getVal);

                    if (currentData.gallery && Array.isArray(currentData.gallery)) {
                        galleryData = currentData.gallery.concat(Array(8).fill("")).slice(0, 8);
                    }
                    renderGalleryGrid();

                    const plan = currentData.plan || 'free';
                    const badge = document.getElementById('planBadge');
                    if(plan === 'premium') {
                        badge.innerText = "PREMIUM";
                        badge.className = "bg-yellow-500 text-black text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wider";
                    }
                } else {
                    renderGalleryGrid();
                }
            } catch (e) {
                console.error("Error load:", e);
            }
        }

        function fillForm(data, getVal) {
            document.getElementById('theme').value = data.theme || 'gold';
            document.getElementById('music').value = data.music || '';
            document.getElementById('coverPhoto').value = data.coverPhoto || '';

            document.getElementById('groomName').value = getVal('groomName', 'pria.nama');
            document.getElementById('groomNick').value = getVal('groomNick', 'pria.panggilan');
            document.getElementById('groomPhoto').value = getVal('groomPhoto', 'pria.foto');
            document.getElementById('groomFather').value = getVal('groomFather', 'pria.ayah');
            document.getElementById('groomMother').value = getVal('groomMother', 'pria.ibu');

            document.getElementById('brideName').value = getVal('brideName', 'wanita.nama');
            document.getElementById('brideNick').value = getVal('brideNick', 'wanita.panggilan');
            document.getElementById('bridePhoto').value = getVal('bridePhoto', 'wanita.foto');
            document.getElementById('brideFather').value = getVal('brideFather', 'wanita.ayah');
            document.getElementById('brideMother').value = getVal('brideMother', 'wanita.ibu');

            document.getElementById('eventDate').value = getVal('eventDate', 'acara.tanggal');
            document.getElementById('eventTime').value = getVal('eventTime', 'acara.waktu');
            document.getElementById('eventLocation').value = getVal('eventLocation', 'acara.alamat_lokasi');
            document.getElementById('mapsUrl').value = getVal('mapsUrl', 'acara.map');
            
            document.getElementById('bankName').value = getVal('bankName', 'amplop.bank');
            document.getElementById('accountNumber').value = getVal('accountNumber', 'amplop.rek');
            document.getElementById('accountHolder').value = getVal('accountHolder', 'amplop.an');
        }

        function renderGalleryGrid() {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = "";
            galleryData.forEach((url, index) => {
                const div = document.createElement('div');
                div.className = "gallery-slot";
                div.onclick = () => uploadGallery(index); 
                if (url) {
                    div.innerHTML = `
                        <img src="${url}">
                        <div class="overlay">
                            <i class="fas fa-camera text-white text-xl mb-2"></i>
                            <span class="text-[8px] text-white bg-red-500 px-2 py-1 rounded" onclick="event.stopPropagation(); deleteGallery(${index})">HAPUS</span>
                        </div>
                    `;
                } else {
                    div.innerHTML = `<i class="fas fa-plus text-slate-300 text-xl"></i>`;
                }
                container.appendChild(div);
            });
        }

        window.uploadGallery = async (index) => {
            const { value: file } = await Swal.fire({
                title: `Foto Galeri ${index + 1}`, input: 'file', inputAttributes: { 'accept': 'image/*' }
            });
            if (file) {
                Swal.fire({ title: 'Mengupload...', didOpen: () => Swal.showLoading() });
                const url = await uploadFile(file);
                if (url) {
                    galleryData[index] = url; renderGalleryGrid(); Swal.close(); saveData();
                }
            }
        };

        window.deleteGallery = (index) => {
            galleryData[index] = ""; renderGalleryGrid(); saveData();
        };

        window.handleFileUpload = async (inputId, type) => {
            const acceptType = type === 'audio' ? 'audio/*' : 'image/*';
            const { value: file } = await Swal.fire({
                title: 'Pilih File', input: 'file', inputAttributes: { 'accept': acceptType }
            });
            if (file) {
                Swal.fire({ title: 'Mengupload...', didOpen: () => Swal.showLoading() });
                const url = await uploadFile(file);
                if (url) {
                    document.getElementById(inputId).value = url; Swal.close(); saveData(); 
                }
            }
        };

        window.saveData = async () => {
            if (!currentUser) return;
            const btn = document.querySelector('button[onclick="saveData()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            btn.disabled = true;

            const newData = {
                uid: currentUser.uid,
                email: currentUser.email,
                updatedAt: new Date(),
                theme: document.getElementById('theme').value,
                music: document.getElementById('music').value,
                coverPhoto: document.getElementById('coverPhoto').value,
                groomName: document.getElementById('groomName').value,
                groomNick: document.getElementById('groomNick').value,
                groomPhoto: document.getElementById('groomPhoto').value,
                groomFather: document.getElementById('groomFather').value,
                groomMother: document.getElementById('groomMother').value,
                brideName: document.getElementById('brideName').value,
                brideNick: document.getElementById('brideNick').value,
                bridePhoto: document.getElementById('bridePhoto').value,
                brideFather: document.getElementById('brideFather').value,
                brideMother: document.getElementById('brideMother').value,
                eventDate: document.getElementById('eventDate').value,
                eventTime: document.getElementById('eventTime').value,
                eventLocation: document.getElementById('eventLocation').value,
                mapsUrl: document.getElementById('mapsUrl').value,
                bankName: document.getElementById('bankName').value,
                accountNumber: document.getElementById('accountNumber').value,
                accountHolder: document.getElementById('accountHolder').value,
                gallery: galleryData, 
                plan: currentData.plan || 'free'
            };

            try {
                await setDoc(doc(db, "invitations", currentUser.uid), newData, { merge: true });
                currentData = newData; 
                Swal.fire({
                    icon: 'success', title: 'Tersimpan!', timer: 1500, showConfirmButton: false, toast: true, position: 'top-end'
                });
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.previewInvitation = () => {
            if (!currentUser) return;
            Swal.fire({ title: 'Menyiapkan Preview...', timer: 1000, didOpen: () => { Swal.showLoading() } })
            .then(() => window.open(`view.html?uid=${currentUser.uid}`, '_blank'));
        };

        window.logout = () => {
            Swal.fire({ title: 'Keluar?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' })
            .then((result) => { if (result.isConfirmed) signOut(auth).then(() => window.location.href = "index.html"); });
        };
    </script>
</body>
</html>
