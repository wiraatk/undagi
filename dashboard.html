<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pengantin - Undagi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,500;0,600;0,700;1,500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: '#B8860B',      
                        gold_light: '#F4E5BC',
                        dark: '#1A1A1A',
                        paper: '#FFFAF0',     
                        soft_gray: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        serif: ['"Playfair Display"', 'serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Hilangkan Scrollbar tapi tetap bisa scroll */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid #e5e7eb; }
        
        .gallery-slot {
            aspect-ratio: 1; border: 2px dashed #B8860B; border-radius: 1rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; position: relative; background-color: #FFFAF0; transition: all 0.3s;
        }
        .gallery-slot:hover { background-color: #F4E5BC; border-color: #8B6508; }
        .gallery-slot img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-slot .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;
        }
        .gallery-slot:hover .overlay { opacity: 1; }
    </style>
</head>
<body class="bg-paper text-dark pb-32">

    <nav class="bg-white/95 backdrop-blur-md sticky top-0 z-30 shadow-sm border-b border-gray-100">
        <div class="max-w-3xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-dark rounded-full flex items-center justify-center text-white font-serif font-bold">U</div>
                <div class="leading-tight">
                    <h1 class="font-serif font-bold text-dark">Dashboard</h1>
                    <p class="text-[10px] text-gray-500 font-sans truncate max-w-[150px]" id="userEmail">Memuat...</p>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <span id="planBadge" class="hidden sm:inline-block bg-gray-100 text-gray-500 border border-gray-200 text-[10px] px-3 py-1 rounded-full font-bold uppercase tracking-wider mr-1">FREE</span>
                
                <a href="market.html" class="w-9 h-9 flex items-center justify-center rounded-full bg-gold/10 text-gold hover:bg-gold hover:text-white transition relative" title="Vendor Store">
                    <i class="fas fa-store"></i>
                    <span class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 border-2 border-white rounded-full animate-pulse"></span> 
                </a>

                <a href="index.html" class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 hover:bg-dark hover:text-white transition" title="Ke Halaman Depan">
                    <i class="fas fa-home"></i>
                </a>

                <button onclick="logout()" class="w-9 h-9 flex items-center justify-center rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition" title="Keluar">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto p-4 space-y-6">

        <div class="bg-dark rounded-2xl p-5 relative overflow-hidden shadow-lg group">
            <div class="absolute right-0 top-0 w-32 h-32 bg-gold opacity-20 rounded-full blur-2xl transform translate-x-10 -translate-y-10"></div>
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <h3 class="text-gold font-serif font-bold text-lg mb-1">Butuh Fotografer?</h3>
                    <p class="text-gray-400 text-xs max-w-[200px]">Cek katalog vendor Bali. Harga mulai 2.9 Juta.</p>
                </div>
                <a href="market.html" class="bg-gold text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-white hover:text-dark transition shadow-md">
                    Lihat Store &rarr;
                </a>
            </div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gold/10">
            <h2 class="font-serif font-bold text-xl text-dark mb-4 flex items-center gap-2">
                <i class="fas fa-palette text-gold"></i> Tampilan Undangan
            </h2>
            
            <div class="mb-5">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Pilih Tema</label>
                <select id="theme" class="w-full mt-2 p-3 bg-paper rounded-xl border border-gray-200 text-sm font-medium focus:border-gold outline-none">
                    <option value="gold">Gold Luxury (Default)</option>
                    <option value="silver">Silver Minimal</option>
                    <option value="sage">Sage Nature</option>
                    <option value="maroon">Red Maroon</option>
                </select>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Foto Cover Utama</label>
                <div class="flex gap-2 mt-2">
                    <input type="text" id="coverPhoto" placeholder="Link foto atau upload..." class="w-full p-3 bg-paper rounded-xl border border-gray-200 text-xs" readonly>
                    <button onclick="handleFileUpload('coverPhoto', 'image')" class="bg-dark text-white px-4 rounded-xl hover:bg-gold transition"><i class="fas fa-camera"></i></button>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gold/10">
            <h2 class="font-serif font-bold text-xl text-dark mb-4 flex items-center gap-2">
                <i class="fas fa-user-friends text-gold"></i> Data Mempelai
            </h2>
            
            <div class="mb-6 pb-6 border-b border-dashed border-gray-200">
                <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-[10px] font-bold uppercase mb-3 inline-block">Mempelai Pria</span>
                <div class="space-y-3">
                    <input type="text" id="groomName" placeholder="Nama Lengkap Pria" class="w-full p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="groomNick" placeholder="Nama Panggilan" class="p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                        <div class="flex gap-1">
                            <input type="text" id="groomPhoto" placeholder="Link Foto" class="w-full p-3 bg-paper rounded-xl border border-gray-200 text-xs" readonly>
                            <button onclick="handleFileUpload('groomPhoto', 'image')" class="bg-gray-200 px-3 rounded-xl hover:bg-gray-300"><i class="fas fa-upload"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="groomFather" placeholder="Nama Ayah" class="p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                        <input type="text" id="groomMother" placeholder="Nama Ibu" class="p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                    </div>
                </div>
            </div>

            <div>
                <span class="bg-pink-50 text-pink-600 px-2 py-1 rounded text-[10px] font-bold uppercase mb-3 inline-block">Mempelai Wanita</span>
                <div class="space-y-3">
                    <input type="text" id="brideName" placeholder="Nama Lengkap Wanita" class="w-full p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="brideNick" placeholder="Nama Panggilan" class="p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                        <div class="flex gap-1">
                            <input type="text" id="bridePhoto" placeholder="Link Foto" class="w-full p-3 bg-paper rounded-xl border border-gray-200 text-xs" readonly>
                            <button onclick="handleFileUpload('bridePhoto', 'image')" class="bg-gray-200 px-3 rounded-xl hover:bg-gray-300"><i class="fas fa-upload"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="brideFather" placeholder="Nama Ayah" class="p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                        <input type="text" id="brideMother" placeholder="Nama Ibu" class="p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gold/10">
            <h2 class="font-serif font-bold text-xl text-dark mb-4 flex items-center gap-2">
                <i class="fas fa-calendar-alt text-gold"></i> Waktu & Lokasi
            </h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Tanggal</label>
                        <input type="date" id="eventDate" class="w-full mt-1 p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Jam (WITA)</label>
                        <input type="time" id="eventTime" class="w-full mt-1 p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Lokasi / Nama Gedung</label>
                    <textarea id="eventLocation" rows="2" class="w-full mt-1 p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none"></textarea>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Link Google Maps</label>
                    <input type="text" id="mapsUrl" placeholder="https://goo.gl/maps/..." class="w-full mt-1 p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gold/10">
            <h2 class="font-serif font-bold text-xl text-dark mb-4 flex items-center gap-2">
                <i class="fas fa-wallet text-gold"></i> Amplop Digital
            </h2>
            <div class="space-y-3">
                <input type="text" id="bankName" placeholder="Nama Bank (BCA/BRI/Dana)" class="w-full p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="accountNumber" placeholder="No. Rekening" class="p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                    <input type="text" id="accountHolder" placeholder="Atas Nama" class="p-3 bg-paper rounded-xl border border-gray-200 text-sm focus:border-gold outline-none">
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gold/10">
            <h2 class="font-serif font-bold text-xl text-dark mb-4 flex items-center gap-2">
                <i class="fas fa-images text-gold"></i> Galeri & Musik
            </h2>
            
            <div class="mb-6">
                <label class="text-xs font-bold text-gray-500 mb-3 block flex justify-between items-center">
                    Galeri Foto Prewedding
                    <span class="text-[10px] bg-gold/10 text-gold px-2 py-0.5 rounded border border-gold/20">Max 8 Foto</span>
                </label>
                
                <div class="grid grid-cols-4 gap-2" id="galleryContainer">
                    </div>
                <p class="text-[10px] text-gray-400 mt-2">*Klik kotak untuk upload foto.</p>
            </div>

            <hr class="border-dashed border-gray-200 my-6">

            <div>
                <label class="text-xs font-bold text-gray-500 flex justify-between items-center mb-2">
                    Musik Latar (MP3)
                    <span class="text-[10px] bg-dark text-white px-2 py-0.5 rounded">Auto Play</span>
                </label>
                <div class="flex gap-2">
                    <input type="text" id="music" placeholder="Link musik / Upload MP3..." class="w-full p-3 bg-paper rounded-xl border border-gray-200 text-xs text-gray-500" readonly>
                    <button onclick="handleFileUpload('music', 'audio')" class="bg-gold/10 text-gold border border-gold px-4 rounded-xl hover:bg-gold hover:text-white transition flex items-center gap-2 font-bold text-xs whitespace-nowrap">
                        <i class="fas fa-music"></i> Upload
                    </button>
                </div>
            </div>
        </div>

    </main>

    <div class="fixed bottom-0 w-full glass-nav p-4 z-40">
        <div class="max-w-3xl mx-auto flex gap-3">
            <button onclick="previewInvitation()" class="flex-1 bg-white border border-gray-200 text-dark font-bold py-3.5 rounded-full hover:bg-gray-50 transition flex items-center justify-center gap-2">
                <i class="fas fa-eye"></i> <span class="hidden sm:inline">Preview</span>
            </button>
            <button onclick="saveData()" class="flex-1 bg-gold text-white font-bold py-3.5 rounded-full hover:bg-yellow-600 transition flex items-center justify-center gap-2 shadow-lg shadow-gold/30">
                <i class="fas fa-save"></i> Simpan
            </button>
            <a href="manage.html" class="flex-1 bg-dark text-white font-bold py-3.5 rounded-full hover:bg-gray-800 transition flex items-center justify-center gap-2 shadow-lg">
                <i class="fas fa-share-alt"></i> Bagikan
            </a>
        </div>
    </div>

    <script type="module">
        import { auth, db, doc, getDoc, setDoc, onAuthStateChanged, signOut } from './firebase-config.js';
        import { uploadFile } from './cloudinary.js';

        let currentUser = null;
        let currentData = {};
        let galleryData = ["", "", "", "", "", "", "", ""]; 

        // 1. CEK LOGIN
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmail').innerText = user.email;
                loadData(user.uid);
            } else {
                window.location.href = "login.html";
            }
        });

        // 2. LOAD DATA
        async function loadData(uid) {
            try {
                const docSnap = await getDoc(doc(db, "invitations", uid));
                if (docSnap.exists()) {
                    currentData = docSnap.data();
                    
                    const getVal = (field, oldField) => {
                        return currentData[field] || (currentData[oldField.split('.')[0]] ? currentData[oldField.split('.')[0]][oldField.split('.')[1]] : '') || '';
                    };

                    fillForm(currentData, getVal);

                    if (currentData.gallery && Array.isArray(currentData.gallery)) {
                        galleryData = currentData.gallery.concat(Array(8).fill("")).slice(0, 8);
                    }
                    renderGalleryGrid();

                    // Badge Plan
                    const plan = currentData.plan || 'free';
                    const badge = document.getElementById('planBadge');
                    if(plan === 'premium') {
                        badge.innerText = "PREMIUM";
                        badge.className = "hidden sm:inline-block bg-gold text-white text-[10px] px-3 py-1 rounded-full font-bold uppercase tracking-wider mr-1 shadow-sm";
                    }
                } else {
                    renderGalleryGrid(); 
                }
            } catch (e) {
                console.error("Error load:", e);
            }
        }

        // 3. ISI FORM
        function fillForm(data, getVal) {
            document.getElementById('theme').value = data.theme || 'gold';
            document.getElementById('music').value = data.music || '';
            document.getElementById('coverPhoto').value = data.coverPhoto || '';

            document.getElementById('groomName').value = getVal('groomName', 'pria.nama');
            document.getElementById('groomNick').value = getVal('groomNick', 'pria.panggilan');
            document.getElementById('groomPhoto').value = getVal('groomPhoto', 'pria.foto');
            document.getElementById('groomFather').value = getVal('groomFather', 'pria.ayah');
            document.getElementById('groomMother').value = getVal('groomMother', 'pria.ibu');

            document.getElementById('brideName').value = getVal('brideName', 'wanita.nama');
            document.getElementById('brideNick').value = getVal('brideNick', 'wanita.panggilan');
            document.getElementById('bridePhoto').value = getVal('bridePhoto', 'wanita.foto');
            document.getElementById('brideFather').value = getVal('brideFather', 'wanita.ayah');
            document.getElementById('brideMother').value = getVal('brideMother', 'wanita.ibu');

            document.getElementById('eventDate').value = getVal('eventDate', 'acara.tanggal');
            document.getElementById('eventTime').value = getVal('eventTime', 'acara.waktu');
            document.getElementById('eventLocation').value = getVal('eventLocation', 'acara.alamat_lokasi');
            document.getElementById('mapsUrl').value = getVal('mapsUrl', 'acara.map');
            
            document.getElementById('bankName').value = getVal('bankName', 'amplop.bank');
            document.getElementById('accountNumber').value = getVal('accountNumber', 'amplop.rek');
            document.getElementById('accountHolder').value = getVal('accountHolder', 'amplop.an');
        }

        // 4. RENDER GALERI
        function renderGalleryGrid() {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = "";
            galleryData.forEach((url, index) => {
                const div = document.createElement('div');
                div.className = "gallery-slot";
                div.onclick = () => uploadGallery(index); 
                if (url) {
                    div.innerHTML = `
                        <img src="${url}">
                        <div class="overlay">
                            <i class="fas fa-camera text-white text-xl mb-2"></i>
                            <span class="text-[8px] text-white bg-red-500 px-2 py-1 rounded" onclick="event.stopPropagation(); deleteGallery(${index})">HAPUS</span>
                        </div>
                    `;
                } else {
                    div.innerHTML = `<i class="fas fa-plus text-gold/50 text-xl"></i>`;
                }
                container.appendChild(div);
            });
        }

        // 5. UPLOAD & DELETE
        window.uploadGallery = async (index) => {
            const { value: file } = await Swal.fire({
                title: `Foto Galeri ${index + 1}`, input: 'file', inputAttributes: { 'accept': 'image/*' }
            });
            if (file) {
                Swal.fire({ title: 'Mengupload...', didOpen: () => Swal.showLoading() });
                const url = await uploadFile(file);
                if (url) {
                    galleryData[index] = url; renderGalleryGrid(); Swal.close(); saveData(true);
                }
            }
        };

        window.deleteGallery = (index) => {
            galleryData[index] = ""; renderGalleryGrid(); saveData(true);
        };

        window.handleFileUpload = async (inputId, type) => {
            const acceptType = type === 'audio' ? 'audio/*' : 'image/*';
            const { value: file } = await Swal.fire({
                title: 'Pilih File', input: 'file', inputAttributes: { 'accept': acceptType }
            });
            if (file) {
                Swal.fire({ title: 'Mengupload...', didOpen: () => Swal.showLoading() });
                const url = await uploadFile(file);
                if (url) {
                    document.getElementById(inputId).value = url; Swal.close(); saveData(true); 
                }
            }
        };

        // 6. SIMPAN DATA
        window.saveData = async (silent = false) => {
            if (!currentUser) return;
            const btn = document.querySelector('button[onclick="saveData()"]');
            const originalText = btn.innerHTML;
            
            if(!silent) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
                btn.disabled = true;
            }

            const newData = {
                uid: currentUser.uid,
                email: currentUser.email,
                updatedAt: new Date(),
                theme: document.getElementById('theme').value,
                music: document.getElementById('music').value,
                coverPhoto: document.getElementById('coverPhoto').value,
                groomName: document.getElementById('groomName').value,
                groomNick: document.getElementById('groomNick').value,
                groomPhoto: document.getElementById('groomPhoto').value,
                groomFather: document.getElementById('groomFather').value,
                groomMother: document.getElementById('groomMother').value,
                brideName: document.getElementById('brideName').value,
                brideNick: document.getElementById('brideNick').value,
                bridePhoto: document.getElementById('bridePhoto').value,
                brideFather: document.getElementById('brideFather').value,
                brideMother: document.getElementById('brideMother').value,
                eventDate: document.getElementById('eventDate').value,
                eventTime: document.getElementById('eventTime').value,
                eventLocation: document.getElementById('eventLocation').value,
                mapsUrl: document.getElementById('mapsUrl').value,
                bankName: document.getElementById('bankName').value,
                accountNumber: document.getElementById('accountNumber').value,
                accountHolder: document.getElementById('accountHolder').value,
                gallery: galleryData, 
                plan: currentData.plan || 'free'
            };

            try {
                await setDoc(doc(db, "invitations", currentUser.uid), newData, { merge: true });
                currentData = newData; 
                if(!silent) {
                    Swal.fire({
                        icon: 'success', title: 'Tersimpan!', timer: 1500, showConfirmButton: false, toast: true, position: 'top-end'
                    });
                }
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            } finally {
                if(!silent) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        };

        // 7. ACTION BUTTONS
        window.previewInvitation = () => {
            if (!currentUser) return;
            Swal.fire({ title: 'Menyiapkan Preview...', timer: 1000, didOpen: () => { Swal.showLoading() } })
            .then(() => window.open(`view.html?uid=${currentUser.uid}`, '_blank'));
        };

        window.logout = () => {
            Swal.fire({ title: 'Keluar?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya', confirmButtonColor: '#1A1A1A' })
            .then((result) => { if (result.isConfirmed) signOut(auth).then(() => window.location.href = "index.html"); });
        };
    </script>
</body>
</html>
