<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script type="module">
        import { auth, db, doc, getDoc, onAuthStateChanged } from './firebase-config.js';

        AOS.init({ duration: 1000, once: true });

        // === LOGIC ===
        const bgm = document.getElementById('bgm');
        let isPlaying = false;

        // Default Musik kalau user tidak upload
        const musicLibrary = {
            'romance1.mp3': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
            'acoustic.mp3': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3', 
            'wedding.mp3': 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
        };

        window.openInvitation = () => {
            document.getElementById('cover-screen').classList.add('open');
            setTimeout(() => { document.querySelector('.bottom-nav').classList.add('show'); }, 500);
            
            // Cek apakah ada source musik sebelum play
            if(bgm.src) {
                bgm.play().then(() => {
                    isPlaying = true;
                    document.getElementById('navMusicIcon').classList.add('animate-spin');
                }).catch(e => console.log("Audio autoplay blocked"));
            }
        };

        window.toggleMusic = () => {
            const icon = document.getElementById('navMusicIcon');
            if(isPlaying) { bgm.pause(); icon.classList.remove('animate-spin'); icon.style.opacity = "0.5"; }
            else { bgm.play(); icon.classList.add('animate-spin'); icon.style.opacity = "1"; }
            isPlaying = !isPlaying;
        };

        window.copyRek = () => {
            navigator.clipboard.writeText(document.getElementById('rekDisplay').innerText);
            Swal.fire({icon: 'success', title: 'Tersalin', timer: 1000, showConfirmButton: false, toast: true, position: 'top'});
        };

        // Scroll Spy
        const sections = document.querySelectorAll('section');
        const navLi = document.querySelectorAll('.nav-item');
        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (pageYOffset >= sectionTop - 200) { current = section.getAttribute('id'); }
            });
            navLi.forEach(li => {
                li.classList.remove('active');
                if (li.getAttribute('href') && li.getAttribute('href').includes(current)) li.classList.add('active');
            });
        });

        // === LOAD DATA (INTELLIGENT LOGIC) ===
        onAuthStateChanged(auth, async (currentUser) => {
            const urlParams = new URLSearchParams(window.location.search);
            // Ambil UID dari URL (prioritas) atau dari User Login (preview dashboard)
            const targetUID = urlParams.get('uid') || (currentUser ? currentUser.uid : null);
            const guestName = urlParams.get('to');

            if(guestName) document.getElementById('guestNameDisplay').innerText = decodeURIComponent(guestName);
            if(!targetUID) return; // Kalau tidak ada UID sama sekali, stop.

            try {
                const docSnap = await getDoc(doc(db, "invitations", targetUID));
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // CEK APAKAH YANG MELIHAT ADALAH PEMILIK (OWNER)?
                    // Logic: Kalau user login & UID-nya sama dengan UID undangan = Owner.
                    const isOwner = (currentUser && currentUser.uid === targetUID);
                    
                    renderData(data, isOwner);
                }
            } catch(e) { console.error(e); }
        });

        function renderData(data, isOwner) {
            // Text & Images (Standard)
            document.getElementById('coverNames').innerText = `${data.groomNick || 'Pria'} & ${data.brideNick || 'Wanita'}`;
            document.getElementById('groomNickDisplay').innerText = data.groomNick;
            document.getElementById('brideNickDisplay').innerText = data.brideNick;
            document.getElementById('groomNameDisplay').innerText = data.groomName;
            document.getElementById('groomParents').innerText = `Bpk. ${data.groomFather} & Ibu ${data.groomMother}`;
            document.getElementById('brideNameDisplay').innerText = data.brideName;
            document.getElementById('brideParents').innerText = `Bpk. ${data.brideFather} & Ibu ${data.brideMother}`;

            if(data.coverPhoto) document.getElementById('coverBg').src = data.coverPhoto;
            if(data.groomPhoto) document.getElementById('groomImg').src = data.groomPhoto;
            if(data.bridePhoto) document.getElementById('brideImg').src = data.bridePhoto;

            // Event & Bank
            if(data.eventDate) {
                const dateObj = new Date(data.eventDate);
                const opts = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                document.getElementById('dateDisplay').innerText = dateObj.toLocaleDateString('id-ID', opts);
            }
            document.getElementById('timeDisplay').innerText = (data.eventTime || '00:00');
            document.getElementById('locationDisplay').innerText = data.eventLocation;
            if(data.mapsUrl) document.getElementById('btnMap').href = data.mapsUrl;
            document.getElementById('bankNameDisplay').innerText = data.bankName;
            document.getElementById('rekDisplay').innerText = data.accountNumber;
            document.getElementById('rekHolderDisplay').innerText = data.accountHolder;

            // === LOGIC FITUR PREMIUM (MUSIK & GALERI) ===
            const plan = data.plan || 'free'; 
            
            // ATURAN: 
            // 1. Jika Premium/Pro -> Tampilkan Semua
            // 2. Jika Free TAPI Owner (Preview) -> Tampilkan Semua (Biar seneng)
            // 3. Jika Free DAN Tamu (Public) -> Sembunyikan
            
            const showPremiumFeatures = (plan !== 'free') || isOwner;

            // --- 1. MUSIK ---
            if (showPremiumFeatures) {
                if(data.music) {
                    // Cek apakah musik link luar atau file upload sendiri
                    if(musicLibrary[data.music]) bgm.src = musicLibrary[data.music];
                    else bgm.src = data.music; // Custom Upload URL
                } else {
                    bgm.src = musicLibrary['romance1.mp3']; // Default
                }
            } else {
                // Kalo Free & Public = No Music
                bgm.src = ""; 
                document.getElementById('navMusicIcon').style.display = 'none'; // Sembunyikan tombol musik
            }

            // --- 2. GALERI ---
            const gallerySection = document.getElementById('gallerySection');
            const galleryGrid = document.getElementById('galleryGrid');
            const navGallery = document.getElementById('navGallery');
            const demoImg = data.coverPhoto || 'https://placehold.co/400x600/A47E5C/ffffff?text=Undagi';

            // Reset dulu
            gallerySection.style.display = 'none';
            navGallery.style.display = 'none';

            if (showPremiumFeatures) {
                // Tampilkan Galeri (Simulasi jumlah foto berdasarkan plan bayangan)
                gallerySection.style.display = 'block';
                navGallery.style.display = 'block';
                gallerySection.classList.remove('hidden');

                // Jika Owner Free (Preview), kita kasih lihat seolah-olah Pro (5 Foto)
                const displayCount = (plan === 'premium') ? 8 : 5;
                
                let html = "";
                // Logic Grid Gallery
                if(displayCount === 5) {
                     galleryGrid.className = "grid grid-cols-2 gap-2";
                     html = `
                        <div class="h-48 rounded-lg overflow-hidden bg-gray-200"><img src="${demoImg}" class="w-full h-full object-cover"></div>
                        <div class="h-48 rounded-lg overflow-hidden bg-gray-200"><img src="${demoImg}" class="w-full h-full object-cover"></div>
                        <div class="col-span-2 h-48 rounded-lg overflow-hidden bg-gray-200"><img src="${demoImg}" class="w-full h-full object-cover"></div>
                        <div class="h-48 rounded-lg overflow-hidden bg-gray-200"><img src="${demoImg}" class="w-full h-full object-cover"></div>
                        <div class="h-48 rounded-lg overflow-hidden bg-gray-200"><img src="${demoImg}" class="w-full h-full object-cover"></div>
                    `;
                } else {
                    // Premium 8 Foto
                    galleryGrid.className = "grid grid-cols-2 md:grid-cols-4 gap-2";
                    for(let i=0; i<8; i++) {
                        html += `<div class="h-40 rounded-lg overflow-hidden bg-gray-200 shadow-sm"><img src="${demoImg}" class="w-full h-full object-cover"></div>`;
                    }
                }
                galleryGrid.innerHTML = html;
            }
            
            // ALERT KHUSUS OWNER (JIKA FREE)
            if(isOwner && plan === 'free') {
                Swal.fire({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
                    icon: 'info', title: 'Mode Preview',
                    text: 'Fitur Musik & Galeri terlihat karena Anda pemilik. Tamu tidak akan melihat ini sebelum Upgrade.'
                });
            }
        }
    </script>
